CHANGED KERNEL VERSION, BECAUSE THE 5.11 CANNOT CONNECT TO INTERNET
INSTALLED linux-generic-5.15 because nvidia drivers not working(from: https://www.linuxcapable.com/how-to-install-linux-kernel-5-15-on-ubuntu-20-04/)


Downloaded nvidia drivers from System+Updates 
TRIED FROM DOWNLOADING THE RUN FILE FROM NVIDIA DRIVER SITE,
BUT GOT ERRORS AND SCREEN SAID System+Updates better way

>>>>>sudo prime-select nvidia
>>>>>sudo update-initramfs -u

	from: https://linuxconfig.org/how-to-install-the-nvidia-drivers-on-ubuntu-20-04-focal-fossa-linux
	
CUDA installed:
	wget https://developer.download.nvidia.com/compute/cuda/repos/ubuntu2004/x86_64/cuda-ubuntu2004.pin
	sudo mv cuda-ubuntu2004.pin /etc/apt/preferences.d/cuda-repository-pin-600
	wget https://developer.download.nvidia.com/compute/cuda/11.5.1/local_installers/cuda-repo-ubuntu2004-11-5-local_11.5.1-495.29.05-1_amd64.deb
	sudo dpkg -i cuda-repo-ubuntu2004-11-5-local_11.5.1-495.29.05-1_amd64.deb
	sudo apt-key add /var/cuda-repo-ubuntu2004-11-5-local/7fa2af80.pub
	sudo apt-get update
	sudo apt-get -y install cuda

	from : https://developer.nvidia.com/cuda-downloads?target_os=Linux&target_arch=x86_64&Distribution=Ubuntu&target_version=20.04&target_type=deb_local

	https://docs.nvidia.com/cuda/cuda-installation-guide-linux/index.html
	
	>>>>nvcc --version
	NOW INSTALLED IT WITH >>>apt install nvidia-cuda-toolkit
LOCATION: /usr/bin/nvcc
location: /usr/local/cuda/
	  /usr/lib/cuda
	  
	6/4/2022  Tensorlfow apaprently is reading from /usr/lib/x86../libcudnn.so.
		  copied the files from the downloaded cudnn 7.6.5 (i also copied them to /usr/local/cuda)
		  to the folder /usr/lib/x86.. (didnt change /usr/include/cudnn.h)
		  and did chmod (as seen in official nvidia cudnn installation guide
		  https://docs.nvidia.com/deeplearning/cudnn/install-guide/index.htmls)
		  
		  copied them back before, now there is a libcudnn.so.8 file modified today
		  in the .../x86.. folder and the programm does not work->need to comment out the gpu list devices code


CHANGING NVIDIA PACKAGE FROM SOFTWARE&UPDATES UNINSTALLS NVCC-> HAVE TO REINSTALL nvidia-cuda-toolkits each time
	
Downloaded CUDNN

NVIDIA-SMI NOT WORKING!!!!!!!!! NOW DOWNLOADED NVIDIA DRIVERS FROM SYSTEM+UPDATES

NVIDIA-SMI WORKED! sudo ubuntu-drivers autoinstall 


PROGRAMM KILLED ON UBUNTU, WINDOWS RUNS IT

adde a script cuda_path.sh in /etc/profile.d/ where i export the path to the cuda library
i exported the PATH and the LD_LIBRARY_PATH to /usr/local/cuda-11.6/bin and .../lib64 respectively.




CANNOT VISUALIZE-> WHERE IS dcase_output=TRue????????/



8/4/2022
tf 2.8.0, 2.5.0 not working

cuda 11.6, cudnn 7.4.6 not working
cuda 11.6, cudnn 8.3.1 not working

will try tf 2.2.0, cuda 10.1, cudnn 7.5
OR try tf > 2.4. with cuda 11->worked for baseline 

9/4/2022

sometimes uninstalling keras and installing later works
if there is a list devices error in tensorflow_backend, reinstall keras

downloaded tf 2.4.1 and keras 2.4.1
with cuda 11.6 and cudnn 8.1
also may need to do online datra augm to work with google collab
changed channels_first to channels_last because rank problem in bigru and lstm

tried downloading tf-nightly-gpu->it got fucked:
dont know why but tensorflow is fucked gives me cannot import dtesnor error
versions 2.2, 2.0, 2.4.1, 1.15 and keras 2.4.1 and 2.3.1

just deleted the keras folder from site-packages, it contained some folders that were installed with tf-nightly-gpu and were not deleted even with pip uninstall keras

copied all windows files to ubuntu now they are same, to get the ubuntu version back, go to github on ubuntu branch and take files from todays date 9/4/2022

10/4/2022
installed tf 2.2
trying to install cuda 10.1 and cudnn 7.5
changed script /etc/profiler.d/cuda_path.sh from 11.6 to 10.1

currently running cuda 11.6, cudnn 8.1 trying to run baseline with gpu(i also successfully done this on saturday), but conformer could not run

downloaded cuda 10.1 but libcublas was missing:
https://github.com/tensorflow/tensorflow/issues/26182
some library packages also downloade in /usr/local/cuda-10.2 (wtf nvidia)
so i exported the path in /etc/profiler.d/cuda_path.sh from 10.1 to 10.2 in LD_LIBRARY_PATH

made an error in above script and had to press ctr+alt+f3 and then i typed reboot and now wifi is not working!! wow great job! i love this so much i wanna killl myself

cuda 10.1 and cudnn 7.6 not working->gives failed to initialize conv layer ..

changed back to cuda 11.6 and cudnn 7.6 but does not work (cannot open libcublas.so.10(it has 11))

NOT WORKING:
tf 2.2.0, cuda 11.6, cudnn 7.6
tf 2.2.0, cuda 10.1, cudnn 7.5
tf 2.4.1, cuda 11.6, cudnn 8.4 only baseline

changing all to tensorflow.keras
trying with cuda 11.6, 7.6, tf 2.4.1, keras 2.4.1 
gives error:failed to create cublas handle: CUBLAS_STATUS_NOT_INITIALIZED
Could not create cudnn handle: CUDNN_STATUS_INTERNAL_ERROR
tensorflow.python.framework.errors_impl.UnknownError:  Failed to get convolution algorithm. This is probably because cuDNN failed to initialize, so try looking to see if a warning log message was printed above.
THIS COULD BE MEMORY PROBLEM! NOT VERSION

will try cuda 11, cudnn 8.0.4
did not have enough space on root, will reboot and try tf 2.2.0, cuda 10.1 and 7.6 (i know i already have but will try and fix)

also google colab does not run so thats great i also spent money n memory on drive and still nothing

very good! i have zero root space for some reason and now i cant even dowl=nload tensorflow!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
deleted an old kernel 

tf 2.2.0, keras 2.3.1, cuda 10.1, cudnn 7.6.4->Still same error as cuda 11.6, cudnn 7.6, tf 2.4.1 as above
copied old code that worked from saturday " resnet 18 and 34 copied from main branch "(it has keras.layers instead of before tensorflow.keras.layers in keras_models.py)

TODO:::
get old ubuntu github from 9/4/2022 and try it with 2.4.1, 2..4.1, 11.6, 8.4->done, only cpu working, no libcusolver.so.10
try the exact code from windows (uninstall cuda 10.1, install 11.0 and cudnn 8.0)
none of the above worked...
rolled back to commit of 9/4/2022 "tf 2.4.1. conformer debugging" and it worked,
with tf 2.4.1, keras 2.4.1, cuda 11 (and also exported the cuda 10.1 and 10.2 lib64 to the LD_LIBRARY_PATH) and cudnn 8.4

the old version worls for baseline! and on gpu as well(WITH TF AND CUDA MENTIONED IN ABOVE SENTENCE)
but gives OOM with resnet and a different error with conformer

lowering batch size to 2 and increazing epochs_per_fit to 10 made the resnet18 work!!
resnet32 out of memory
changed the resnet in order to come back to original dimensions after each stage
(so it does not go 64->128->256->512 BUT 64->(128->)64->(256)->64->(512)->64)(pseudoresnet)
added max pooling after each stage too
parameters fell from 27 million to 5 million
batch size 4, steps per epoch = 5

changed conv2d to conv1d in res_conv_identity18 to lower parameters and memory

for conformer::will try to call conformer_fun

TODO:: buy new gpu 
	look into google colab and if not into the lamda cloud gpu server
	pytorch !!!!!
13/4/2022

dont knpw why but my latest code did not upliad to git
and now i have an old commit
i m gonna kill myself now

i switched res_conv18 the last 2 conv layers to take filter f2 instead of f1
same on res_identity18
also added a maxpooling layer every end of stage except stage 4
6 million params
now i will attempt conv2d->conv1d in res_identity18

now for some reason i get the CUBLAS_STATUS_NOT_INITIALIZED.... need to revert back... wtf

commit that worked without the error :d447a573d2c75c236e9a82a403f2f4bf9c17950c 
i reverted back to this and changed the cls_compute_seld_results, cls_feature_class and keras_models to the most recent commit with the pseudoresnet
keras_models code seems to be causing the error

REMEMBER TO MANUALLY SUBMIT TO GITHUB FROM NOW ON

next:: TRY AND DEBUG CONFORMER

changed num_head = 4 and dim = 32 from 8 and 64 respectively
also changed batch_size to 2 and it runs!
but it fails at the end with error::: 
Got 0 inputs for equation "...HNO,...HMO->...HNM", expecting 2

FOUND ERROR:: For CUBLAS_STATUS_NOT_INITIALIZED::
In keras_models i have this on top:
config = tf.compat.v1.ConfigProto(gpu_options=tf.compat.v1.GPUOptions(allow_growth=True))
sess = tf.compat.v1.Session(config=config)

but it does not work if i have this instead:
sess = tf.compat.v1.Session(config=tf.compat.v1.ConfigProto(log_device_placement=True))

so in the code that i had the 2nd thing instead of the 1st, it gave error CUBLAS_STATUS_NOT_INITIALIZED

14/4/2022

Fixed the Got 0 inputs for equation "...HNO,...HMO->...HNM", expecting 2
by changing the scaled_dot_product to an old version that used tf.matmul
instead of tf.einsum

wait, keras has MHSA ready iimplemented, if mine doersnt work i wil use that

15/4/2022

the conformer did run but gave no improvement, constant 0.0380 loss in 30 epochs...
not sure why but i changed code to 2d inputs for conformer

also in asus laptop, in google colab, i try and run a ready conformer_tf from github:
https://github.com/Rishit-dagli/Conformer/blob/9a89d28d2071d68dc6d7745747ff40c89bf85393/conformer_tf/

new gpu?? 
or just replace attention code with the github above->>did this, replaced my MHSA with the Attention layer, cause the whole conformer of the github needs some tinkering(which im trying in colab)->no improvement

if conformer does not work, just try parallel parameter sharing or another network

LOOK INTO ATTENTION AGAIN alliws de tha katalavw ti paei lathos
changed all classes from the ready conformer to def
try again with tensorflow ready github conformer(using classes) and look to change onlythe load_model in keras_models.py->make it import from tf not keras->i need to do this to look into checkpointing, i dont think it can save weights if it uses def instead of a class layer

also installed anaconda environment but deactivated it->>do not need it currently(since cuda thank god works with tensorflow natively) but usefull->>If i need in future, i already have anaconda installed, just need to create new venvs following this link:
https://docs.conda.io/projects/conda/en/latest/user-guide/tasks/manage-environments.html

17/4/2022

after anaconda i get:
failed call to cuInit: CUDA_ERROR_UNKNOWN: unknown error

deactivated environment and deleted and reestarted now it works
(still get the (base) venv in the left side of the terminal command line)

LOOK TO CHANGE THE EINSUM!!

18/4/2022

looking into tensorboard to visualize why resnet18 stays the same loss (and conformer)

also need to look into checkpoints!!
for some reason running resnet18 and rsnet34 in ubuntu lenovo takes 2200 secs(pseudoresnet), while it took 500 before....(but gives -7.000e-4 los wtf)

running resnet18 data augmented (taken from main github,real resnet i trained in vienni)on turbox gives constant loss
also same for google colab (taken from ubuntu pseudoresnet)

uncommented from tensorflow wimport keras in keras_models.py
Trying to use old positional embedding (mine) since maybe i need dimensions of rel_pos_emb
to be (b h d r(n)) not ( n r d )
Did not use old positional embedding, just added a np.newaxis on rel_pos_emb
to have a batch dimension = 1 (b n r d)
now i changed all einsum to matmul nut get MemoryError on first epoch when it tries to save the model on seld.py
->>solved by adding MaxpoolLayer before conformer->seq_len was 300 i added maxpool layer with poolsize=(5,4) and made it to seq len = 60
 runnning ready-conformer for 4 batch size and data augm == 2(RandomShift)
 
 Also tried to implement checkpoint in google colab( so in my drive's files)
 which also has the latest ubuntu pseudonet verrion for resnet18
 will try and run pseudoresnet18 in colab
 
DO::TRY PYTORCH IN A CUDA ENVIRONMENT FOR CONFORMER FROM lucidreams/github->created one here in lenovo ubuntu, just need to test it
-Try pseudonet in turbox in case loss stays the same

ALSO if memory runs out, try and add seld_feat_labels to external hard drive aand link them to project via symlinks(serafeim advice)	
19/04/2022

TRIED SPECAUGMENT ON BASELINE IN UBUNTU ASUS AND ADDED SWA(ensembling weights, maybe not for now) 
try AdaBelief (https://github.com/IRIS-AUDIO/SELD/blob/main) or adaptive gradient clipping(train2v.py) or BinaryCrossEntropy ->> all in IRIS-SELD

will try adabelief on baseline in cpu google colab

20/4/2022
i was training on eval dataset

cannot now run tf 2.4.1 and keras 2.4.1 anywhere... gives AttributeError: module 'tensorflow.compat.v2.__internal__' has no attribute 'tf2'

not on anaconda , not on colab not localy not anywhere
solved by uninstalling keras-nightly, tf-estimator-nightly, tensorflow-estimator and tensorflow-gpu-estimator from pip (another version pakage dependency yay)

NOW managed to locally in turbox make cuda work so now the running procedures are:
NOW RUNNING::->Turbox locally(not on conda anymore) resnet18 da=2 DEV(gpu)->eval done->later will try the AdaBelief from colab because the custom optimizer cant be saved in checkpointing
		 ->Google Colab resnet18 da=2 lr=0.003 AdaBELIEF (cpu)
		 ->Google colab my conformer da=2 (gpu)->checkpointcould not save model corectly, need to renake the conformer with lambda layers (gave gru error that was solved with keras channels_last but when save model is done, it doeas not apply it, so need to remake wohle conformer)
		 	aLSO USING CONFORMER CLASS AND tf 2.0.0 tf-gpu 2.0.0 keras 2.3.1
		->Lenovo ready conformer da=2 DEV(gpu)->eval done
		 ->Asus trying baseline da1(cpu)->

to make locally turbox work, i downloaded cuda 11 instead of 11.1 and to make cupti get recognized, i renamed the cupti64_2020.dll to cupti64_110.dll
and also copied the ptx.exe from cuda/11.1/bin to cuda/11.0/bin to get rid of SubProcess ended with return code: 4294967295 error

21/4/2022

tURBOX LOCALLY::
run the resnet18 (with conv2d not the pseudoresnet) and got results i upload to github
will try and run it again with pseudo

Next: try and run baseline with AdaBelief and lr=0.0003

Asus:: try baseline da1
Google colab Untitled6->try my conformer da2 with tf 200 keras 231
